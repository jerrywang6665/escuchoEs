<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Práctica de Español Mejorado</title>
    <style>
        /* 新增错误提示样式 */
        .error-message {
            color: #d32f2f;
            background-color: #ffebee;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- 在controls下方添加错误提示 -->
        <div class="error-message" id="errorMsg"></div>
        
        <!-- 其余HTML结构保持不变 -->
    </div>

    <script>
        // 添加语音检测
        function checkVoices() {
            return new Promise((resolve) => {
                let voices = synth.getVoices();
                if (voices.length > 0) {
                    resolve(voices);
                } else {
                    synth.onvoiceschanged = () => {
                        voices = synth.getVoices();
                        resolve(voices);
                    };
                }
            });
        }

        // 改进后的生成对话函数
        async function generateNewDialogue() {
            try {
                showError('');
                synth.cancel();
                
                const voices = await checkVoices();
                const hasSpanishVoice = voices.some(v => v.lang.startsWith('es'));
                
                if (!hasSpanishVoice) {
                    showError('No se encontró voz en español. Por favor configura tu navegador');
                    return;
                }

                // 原有生成逻辑...
                
            } catch (error) {
                showError(`Error: ${error.message}`);
            }
        }

        // 改进后的语音播放函数
        async function speakLines(lines) {
            try {
                if (!synth.speaking) {
                    currentUtterances = lines.map((text, index) => {
                        const utterance = new SpeechSynthesisUtterance(text);
                        utterance.lang = 'es-ES';
                        utterance.rate = playbackRate;
                        utterance.voice = getSpanishVoice();
                        utterance.onerror = (event) => {
                            showError(`Error de audio: ${event.error}`);
                        };
                        return utterance;
                    });

                    // 改进的队列管理
                    currentUtterances.forEach((utterance, index) => {
                        if (index < currentUtterances.length - 1) {
                            utterance.onend = () => {
                                currentSentenceIndex = index + 1;
                                synth.speak(currentUtterances[currentSentenceIndex]);
                            };
                        }
                    });

                    synth.speak(currentUtterances[0]);
                    currentSentenceIndex = 0;
                }
            } catch (error) {
                showError(`Error de reproducción: ${error.message}`);
            }
        }

        // 新增辅助函数
        function getSpanishVoice() {
            const voices = synth.getVoices();
            return voices.find(v => v.lang.startsWith('es')) || voices[0];
        }

        function showError(message) {
            const errorDiv = document.getElementById('errorMsg');
            errorDiv.textContent = message;
            errorDiv.style.display = message ? 'block' : 'none';
        }

        // 修改初始化逻辑
        document.getElementById('audioBtn').addEventListener('click', async () => {
            if (!window.speechSynthesis) {
                showError('El navegador no soporta síntesis de voz');
                return;
            }
            await checkVoices();
        });

        // 移除自动初始化
        // generateNewDialogue(); // 注释掉自动初始化
    </script>
</body>
</html>
